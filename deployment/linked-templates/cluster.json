{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "userAssignedIdentities": {
            "type": "object"
        },
        "appGw": {
            "type": "object"
        },
        "subnetCluster": {
            "type": "object"
        },
        "sshPubKey": {
            "type": "string"
        }
    },
    "variables": {
        "location": "[resourceGroup().location]",
        "clusterName": "cluster",
        "clusterPodCIDR": "10.10.0.0/16",
        "clusterServiceCIDR": "10.11.0.0/16",
        "clusterDnsServiceIP": "10.11.0.5",
        "clusterDockerBridgeCIDR": "172.17.0.0/16",
        "kubernetesVersion": "1.21.1",
        "agentPoolProfileNames": ["System","User"]
    },
    "resources": [
        {
            "type": "Microsoft.ContainerService/managedClusters",
            "apiVersion": "2020-11-01",
            "name": "[variables('clusterName')]",
            "location": "[variables('location')]",
            "sku": {
                "name": "Basic",
                "tier": "Free"
            },
            "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                    "[parameters('userAssignedIdentities').identityCluster.id]": {}
                }
            },
            "properties": {
                "kubernetesVersion": "[variables('kubernetesVersion')]",
                "dnsPrefix": "[variables('clusterName')]",
                "copy": [
                    {
                        "name": "agentPoolProfiles",
                        "count": "[length(variables('agentPoolProfileNames'))]",
                        "input": {
                            "name": "[toLower(variables('agentPoolProfileNames')[copyIndex('agentPoolProfiles')])]",
                            "count": 1,
                            "minCount": 0,
                            "maxCount": 1,
                            "vmSize": "Standard_A4_v2",
                            "osType": "Linux",
                            "osDiskSizeGB": 32,
                            "vnetSubnetID": "[parameters('subnetCluster').id]",
                            "enableNodePublicIP": false,
                            "maxPods": 30,
                            "scaleSetPriority": "Regular",
                            "scaleSetEvictionPolicy": "Delete",
                            "enableAutoScaling": true,
                            "mode": "[variables('agentPoolProfileNames')[copyIndex('agentPoolProfiles')]]",
                            "type": "VirtualMachineScaleSets",
                            "availabilityZones": [],
                            "nodeLabels": {},
                            "nodeTaints": [] 
                        }
                    }
                ],
                "linuxProfile": {
                    "adminUsername": "clusteradmin",
                    "ssh": {
                        "publicKeys": [
                            {
                                "keyData": "[parameters('sshPubKey')]"
                            }
                        ]
                    }
                },
                "addonProfiles": {
                    "httpApplicationRouting": {
                        "enabled": false
                    },
                    "omsagent": {
                        "enabled": false
                    },
                    "aciConnectorLinux": {
                        "enabled": false
                    },
                    "azurepolicy": {
                        "enabled": true,
                        "config": {
                            "version": "v2"
                        }
                    },
                    "kubeDashboard": {
                        "enabled": false
                    },
                    "ingressApplicationGateway": {
                        "enabled": true,
                        "config": {
                            "applicationGatewayId": "[parameters('appGw').id]"
                        },
                        "identity": {
                            "clientId": "[parameters('userAssignedIdentities').identityAppGw.clientId]",
                            "objectId": "[parameters('userAssignedIdentities').identityAppGw.principalId]",
                            "resourceId": "[parameters('userAssignedIdentities').identityAppGw.id]"
                        }
                    }
                },
                "podIdentityProfile": {
                    "enabled": false
                },
                "enableRBAC": true,
                "networkProfile": {
                    "networkPlugin": "azure",
                    "networkPolicy": "azure",
                    "podCidr": "[variables('clusterPodCIDR')]",
                    "serviceCidr": "[variables('clusterServiceCIDR')]",
                    "dnsServiceIP": "[variables('clusterDnsServiceIP')]",
                    "dockerBridgeCidr": "[variables('clusterDockerBridgeCIDR')]",
                    "outboundType": "loadBalancer",
                    "loadBalancerSku": "standard",
                    "loadBalancerProfile": "[json('null')]"
                },
                "aadProfile": "[json('null')]",
                "autoScalerProfile": {
                    "scan-interval": "10s",
                    "scale-down-delay-after-add": "10m",
                    "scale-down-delay-after-delete": "20s",
                    "scale-down-delay-after-failure": "3m",
                    "scale-down-unneeded-time": "10m",
                    "scale-down-unready-time": "20m",
                    "scale-down-utilization-threshold": "0.5",
                    "max-graceful-termination-sec": "600"
                },
                "apiServerAccessProfile": {
                    "enablePrivateCluster": false
                }        
            }
        }
    ],
    "outputs": {}
}